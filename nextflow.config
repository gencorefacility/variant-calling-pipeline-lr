params {
    // Input/output parameters
    input              = '/scratch/mk5636/ont-variant-calling/data/B3WJ96_1_sample_1.fastq'
    reference          = '/scratch/work/cgsb/genomes/Public/Fungi/Saccharomyces_cerevisiae/NCBI/R64/GCF_000146045.2_R64_genomic.fna'
    outdir             = '/scratch/mk5636/ont-variant-calling/out'

    // minimap2 preset (https://lh3.github.io/minimap2/minimap2.html)
    //minimap2_preset    = 'lr:hq' // recommended by ONT for recent Nanopore reads (99% accuracy)
    minimap2_preset    = 'map-ont' // alternative minimap2 preset for Nanopore reads

    // Boolean flags to control which variant callers to run
    run_pepper         = true
    run_cutesv         = true // SV's
    run_clair3         = false
    run_sniffles2      = true // SV's
    
    // Tool-specific parameters
    clair3_model       = null  // path to Clair3 model (REQUIRED if run_clair3 is true) (Download model specific to sequencing chemistry)
    clair3_platform    = 'ont' // Clair3 platform (REQUIRED if run_clair3 is true)
    tandem_repeats     = null  // path to tandem repeats BED for Sniffles2 (Optional)
    pepper_preset      = '--ont_r10_q20'  // PEPPER preset (REQUIRED if run_pepper is true). Use -ont_r10_q20 for recent Nanopore reads (99% accuracy)

    // Email address for pipeline status notifications
    email              = '$USER@nyu.edu'

    // Maximum number of samplots to generate per caller (SVs)
    samplot_max_plots      = 5  
}

// Process-specific configurations
// Use ext.args to pass tool-specific command-line arguments
process {
    // Global publishDir for all processes
    publishDir = [
        path: { "${params.outdir}/${task.process.toLowerCase()}" },
        mode: 'copy',
    ]

    // Global error handling (applies to all processes)
    errorStrategy = 'retry'
    maxRetries = 2
    
    // Minimap2 alignment options
    withName: 'MINIMAP2' {
        cpus   = 16
        memory = 64.GB
        time   = 8.h
        //ext.args = '-K 500M -I 8G'  // Optional: Batch size and index options
    }
    
    // PEPPER variant calling options
    withName: 'PEPPER' {
        cpus   = 20 // CHANGE TO 32
        memory = 60.GB // CHANGE TO 128.GB
        time   = 24.h
        // ext.args = '--phased_output'  // Optional: Enable phasing
    }
    
    // cuteSV structural variant calling options
    withName: 'CUTESV' {
        cpus   = 8
        memory = 32.GB
        time   = 6.h
        ext.args = [
            '--min_support 5',      // Minimum read support
            '--min_size 30',        // Minimum SV size
            '--max_size 100000',    // Maximum SV size
            '--min_mapq 20'         // Minimum mapping quality
        ].join(' ')
    }
    
    // Clair3 variant calling options
    withName: 'CLAIR3' {
        cpus   = 16
        memory = 64.GB
        time   = 12.h
        // ext.args = ''
    }
    
    // Sniffles2 structural variant calling options
    withName: 'SNIFFLES2' {
        cpus   = 8
        memory = 32.GB
        time   = 6.h
        ext.args = [
            '--minsvlen 30',        // Minimum SV length
            '--minsupport 3',       // Minimum read support
            '--mapq 20'            // Minimum mapping quality
        ].join(' ')
    }
    
    // MultiQC report options
    withName: 'MULTIQC' {
        cpus   = 2
        memory = 8.GB
        time   = 1.h
        ext.args = '--flat --interactive'  // Flat file structure, interactive plots
    }

    // BCFtools stats options
    withName: 'BCFTOOLS_STATS' {
        cpus   = 4
        memory = 16.GB
        time   = 2.h
        // ext.args = ''
    }
}

// Profile configurations
profiles {
    standard {
        process.executor = 'local'
    }
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        singularity.cacheDir = "$SCRATCH/.singularity_cache"  // Reuse containers
    }
    docker {
        docker.enabled = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
    slurm {
        process.executor = 'slurm'
    }
    conda {
        conda.enabled = true
        conda.cacheDir = "$SCRATCH/.conda_envs"  // Reuse conda environments
    }
}


// ============================================
// REPORTING & MONITORING
// ============================================
report {
    enabled = true
    overwrite = true
    file    = "${params.outdir}/reports/execution_report.html"
}

timeline {
    enabled = true
    overwrite = true
    file    = "${params.outdir}/reports/execution_timeline.html"
}

trace {
    enabled = true
    overwrite = true
    file    = "${params.outdir}/reports/execution_trace.txt"
    fields  = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

dag {
    enabled = true
    file    = "${params.outdir}/reports/dag.html"
}

params {
    multiqc_logo = "${projectDir}/assets/gencore-logo.jpg"
}
